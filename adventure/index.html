<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Adventure Test</title>

    <script src="/libs/babylon.2.1-beta.debug.js"></script>
    <script src="/A3D/source/A3D.js"></script>
    <script src="/A3D/source/classes/Game.js"></script>
    <script src="/A3D/source/classes/Actor.js"></script>
    <script src="/A3D/source/classes/Actor.Player.js"></script>
    <script src="/A3D/source/classes/Scene.js"></script>
    <script src="/A3D/source/classes/Camera.js"></script>
    <script src="/A3D/source/classes/Controls.js"></script>
    <script src="/A3D/source/classes/Input.js"></script>
    <script src="/A3D/source/classes/Resource.js"></script>
    <script src="/A3D/source/classes/Input.Keyboard.js"></script>
    <script src="/A3D/source/classes/Input.Mouse.js"></script>
    <script src="/A3D/source/classes/Overlay.js"></script>
    <script src="/A3D/source/classes/Object2D.js"></script>
    <script src="/A3D/source/classes/Object2D.Image.js"></script>
    <script src="/A3D/source/classes/Action.js"></script>
    <script src="/A3D/source/classes/Trigger.js"></script>
    <script src="/A3D/source/classes/Trigger.Object3D.js"></script>
    <script src="/A3D/source/classes/Trigger.Object3D.Collision.js"></script>
    <script src="/A3D/source/classes/SkeletonAnimations.js"></script>

    <script src='/A3D-Modules/Adventure/Adventure.js'></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id='game'></div>
<script>
    var game,scene,player,target,intTarget;
    function start(){
    game = new A3D.Game.Adventure({
      containerId:'game'
    });

    var next = function(game){
      for(s in game.activeScenes){
        scene = game.activeScenes[s];
      }

      game.clickables = [scene.b3Dscene.meshes[0],scene.b3Dscene.meshes[1]];

      game.run();

      var iNext = function (importObject){
        player = importObject.meshes[0];

        //TODO give
        player.Animation = new A3D.SkeletonAnimations({
          skeleton : importObject.skeletons[0],
          scene : scene,
          frames : 100
        });

        player.Animation.addAnimation('idle',80,100,true);
        player.Animation.addAnimation('running',50,70,true);
        player.Animation.addAnimation('walking',10,40,true);
        player.Animation.addAnimation('startRun',40,45,false,1,function(){
          player.Animation.run('running');
        });

        player.Animation.run('idle');

        var l = function () {
          var mp = player.Controls.input.inputMap['leftmouse'].mouseLocation;
          var pick = scene.b3Dscene.pick(mp.x, mp.y);
          if(pick.pickedMesh.name == 'Plane' ){
            intTarget.position.x = pick.pickedPoint.x;
            intTarget.position.z = pick.pickedPoint.z;

            target.position.x = intTarget.position.x;
            target.position.z = intTarget.position.z;

            player.lookAt(new BABYLON.Vector3(intTarget.position.x,0,intTarget.position.z)); //may need to take out the y

            target.Animation.run('rotate');

            player.dir = new BABYLON.Vector3(0, 0, 1);
            game.actions.move.active = true;
            player.Animation.stop();
            if(BABYLON.Vector3.Distance(player.position,intTarget.position) > 2.5){
              //walk
              player.running = true;
              player.Animation.run('running');
            } else {
              player.running = false;
              player.Animation.run('walk');
            }
          }
       };

       player.Controls = new A3D.Controls({input : game.inputs.mouse});
       player.Controls.addfuncToMap('leftmouse',l);
       player.Controls.input.addToInputMap('leftmouse');
       player.Controls.addControlsToGame(game);

        game.createAction({
          name : 'move',
          id : 'move',
          active : false,
          func : function(){
            if(BABYLON.Vector3.Distance(this.position,intTarget.position) < 3 && this.running){
              player.Animation.stop();
               //walk
               this.running = false;
               player.Animation.run('walking');
            }

           if(this.running){
             this.translate(this.dir,-0.075,0);
           } else {
             this.translate(this.dir,-0.026,0);
           }

           if(this.intersectsMesh(intTarget, true)){
              game.actions.move.active = false;
              target.position.x = 5000;
              intTarget.position.x = 5000;
              target.Animation.stop();
              player.Animation.stop();
              player.Animation.run('idle');
            }

            for(var i = 0; i < scene.b3Dscene.meshes.length; i++){
              if(['Chris','target','InnerTarget'].indexOf(scene.b3Dscene.meshes[i].name) < 0){
                if(this.intersectsMesh(scene.b3Dscene.meshes[i], true)){
                  console.log('Im Colliding with '+scene.b3Dscene.meshes[i].name);

                  game.actions.move.active = false;
                  player.Animation.stop();

                  this.translate(new BABYLON.Vector3(0,0,-1),-0.5,0);
                  player.Animation.run('idle');

                }
              }
            }
          }.bind(player)
        });

        var f = {
          func : function(){
            var mp = c.input.inputMap['leftmouse'].mouseLocation;
            var pick = scene.b3Dscene.pick(mp.x, mp.y);
            pick.pickedMesh.overlayAlpha = 0.2;
            pick.pickedMesh.overlayColor = new BABYLON.Color3(0.8,0.8,0.8);
            pick.pickedMesh.renderOverlay = true;
          },
          afterFunc : function(){
            var mp = c.input.inputMap['leftmouse'].mouseLocation;
            var pick = scene.b3Dscene.pick(mp.x, mp.y);
            pick.pickedMesh.renderOverlay = false;
          }
        }

        var c = new A3D.Controls({input : game.inputs.mouse});

        c.addfuncToMap('leftmouse',f.func,null,f.afterFunc);

        c.input.addToInputMap('leftmouse');
        c.addControlsToGame(game);
      };

      var lNext = function(nm){
        target = nm.meshes[1];
        target.Animation = new A3D.SkeletonAnimations({
          skeleton : nm.skeletons[0],
          scene : scene,
          frames : 100
        });

        target.Animation.addAnimation('rotate',0,100,true);
        intTarget = nm.meshes[0];
        intTarget.visibility = 0;
      };

      scene.importMeshFromFile("/adventure/scenes/", "chris.babylon", "Chris", iNext);
      scene.importMeshFromFile("/adventure/scenes/", "gototarget.babylon", "", lNext);

    };
    game.loadScene('/adventure/scenes/','testScene.babylon', next);
  }
  //TODO add this somehow to the game
  document.addEventListener( "DOMContentLoaded", start, false );

</script>
 </body>
</html>
