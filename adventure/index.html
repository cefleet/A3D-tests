<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Adventure Test</title>

    <script src="/libs/babylon.2.1-beta.debug.js"></script>
    <script src="/A3D/source/A3D.js"></script>
    <script src="/A3D/source/classes/Game.js"></script>
    <script src="/A3D/source/classes/Actor.js"></script>
    <script src="/A3D/source/classes/Actor.Player.js"></script>
    <script src="/A3D/source/classes/Scene.js"></script>
    <script src="/A3D/source/classes/Camera.js"></script>
    <script src="/A3D/source/classes/Controls.js"></script>
    <script src="/A3D/source/classes/Input.js"></script>
    <script src="/A3D/source/classes/Resource.js"></script>
    <script src="/A3D/source/classes/Input.Keyboard.js"></script>
    <script src="/A3D/source/classes/Input.Mouse.js"></script>
    <script src="/A3D/source/classes/Overlay.js"></script>
    <script src="/A3D/source/classes/Object2D.js"></script>
    <script src="/A3D/source/classes/Object2D.Image.js"></script>
    <script src="/A3D/source/classes/Action.js"></script>
    <script src="/A3D/source/classes/Trigger.js"></script>
    <script src="/A3D/source/classes/Trigger.Object3D.js"></script>
    <script src="/A3D/source/classes/Trigger.Object3D.Collision.js"></script>

    <script src='/A3D-Modules/Adventure/Adventure.js'></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id='game'></div>
<script>
    var game,scene,player,skeleton,target,tSkeletons,intTarget;
    function start(){
    game = new A3D.Game.Adventure({
      containerId:'game'
    });

    game.setupScene('/adventure/scenes/','testScene.babylon', function(game){

      for(s in game.activeScenes){
        scene = game.activeScenes[s];
      }

      game.clickables = [scene.b3Dscene.meshes[0],scene.b3Dscene.meshes[1]];

      game.run();

      BABYLON.SceneLoader.ImportMesh("", "/adventure/scenes/", "chris.babylon", scene.b3Dscene, function (newMeshes, particleSystems, skeletons){

        player = newMeshes[0];
        skeleton = skeletons[0];
        scene.b3Dscene.beginAnimation(skeleton, 80,100,true);

        game.createAction({
          name : 'move',
          id : 'move',
          active : false,
          func : function(){
            if(BABYLON.Vector3.Distance(this.position,intTarget.position) < 3 && this.running){
               scene.b3Dscene.stopAnimation(skeleton);
               //walk
               this.running = false;
               scene.b3Dscene.beginAnimation(skeleton, 10,40, true);
            }

           if(this.running){
             this.translate(this.dir,-0.075,0);
           } else {
             this.translate(this.dir,-0.026,0);
           }

           if(this.intersectsMesh(intTarget, true)){
              game.actions.move.active = false;
              target.position.x = 5000;
              intTarget.position.x = 5000;
              scene.b3Dscene.stopAnimation(tSkeleton);
              scene.b3Dscene.stopAnimation(skeleton);
              scene.b3Dscene.beginAnimation(skeleton,40,45,false,1,function(){
                scene.b3Dscene.beginAnimation(skeleton, 80,100,true);
              });
            }

            for(var i = 0; i < scene.b3Dscene.meshes.length; i++){
              if(['Chris','target','InnerTarget'].indexOf(scene.b3Dscene.meshes[i].name) < 0){
                if(this.intersectsMesh(scene.b3Dscene.meshes[i], true)){
                  console.log('Im Colliding with '+scene.b3Dscene.meshes[i].name);

                  game.actions.move.active = false;
                  scene.b3Dscene.stopAnimation(skeleton);

                  this.translate(new BABYLON.Vector3(0,0,-1),-0.5,0);

                  scene.b3Dscene.beginAnimation(skeleton,40,45,false,1,function(){
                    scene.b3Dscene.beginAnimation(skeleton, 80,100,true);
                  });
                }
              }
            }
          }.bind(player)
        });

        var c = new A3D.Controls({input : game.inputs.mouse});

        c.addfuncToMap('leftmouse',function(t){
          var mp = c.input.inputMap['leftmouse'].mouseLocation;
          console.log(mp);
          var pick = scene.b3Dscene.pick(mp.x, mp.y);
          console.log(pick.pickedMesh.name);
          pick.pickedMesh.overlayAlpha = 0.2;
          pick.pickedMesh.overlayColor = new BABYLON.Color3(0.8,0.8,0.8);
          pick.pickedMesh.renderOverlay = true;

        });

        c.input.addToInputMap('leftmouse');
        c.addControlsToGame(game);

      });

      BABYLON.SceneLoader.ImportMesh("", "/adventure/scenes/", "gototarget.babylon", scene.b3Dscene, function (newMeshes, particleSystems, skeletons){
        target = newMeshes[1];
        intTarget = newMeshes[0];
        intTarget.visibility = 0;
        tSkeleton = skeletons[0];
      });

/*

      document.onmousedown = function (evt) {
        var pick = scene.b3Dscene.pick(evt.clientX, evt.clientY);
        for(var i = 0; i < game.clickables.length; i++){
          if(Object.is(game.clickables[i],pick.pickedMesh)){


            //This is highlighting
          //  pick.pickedMesh.outlineColor = new BABYLON.Color4(0.1,0.3,0.8,0.04);
          //  pick.pickedMesh.outlineWidth = 0.2;
          //  pick.pickedMesh.renderOutline = true;

          pick.pickedMesh.overlayAlpha = 0.2;
          pick.pickedMesh.overlayColor = new BABYLON.Color3(0.8,0.8,0.8);
           pick.pickedMesh.renderOverlay = true;
          }
        }
      };
*/
/*
      window.addEventListener("mouseup", function (evt) {
        var pick = scene.b3Dscene.pick(evt.clientX, evt.clientY);
        for(var i = 0; i < game.clickables.length; i++){
          if(Object.is(game.clickables[i],pick.pickedMesh)){

            pick.pickedMesh.renderOutline = false;
            pick.pickedMesh.renderOverlay = false;
          }
        }
      });
*/

//This is the move character item
/*
      window.addEventListener("click", function (evt) {
        var pick = scene.b3Dscene.pick(evt.clientX, evt.clientY);
        if(pick.pickedMesh.name == 'Plane' ){
          intTarget.position.x = pick.pickedPoint.x;
          intTarget.position.z = pick.pickedPoint.z;

          player.lookAt(new BABYLON.Vector3(pick.pickedPoint.x,0,pick.pickedPoint.z)); //may need to take out the y

          //start
          target.position.x = pick.pickedPoint.x;
          target.position.z = pick.pickedPoint.z;

          scene.b3Dscene.beginAnimation(tSkeleton,0,100,true);

          player.dir = new BABYLON.Vector3(0, 0, 1);
          game.actions.move.active = true;
          scene.b3Dscene.stopAnimation(skeleton);
          if(BABYLON.Vector3.Distance(player.position,intTarget.position) > 2.5){
            //walk
            player.running = true;
            scene.b3Dscene.beginAnimation(skeleton,50,70,true);
          } else {
            player.running = false;
            scene.b3Dscene.beginAnimation(skeleton, 10,40, true);
          }
        }
     });
     */
    });

  }


  //TODO add this somehow to the game
  document.addEventListener( "DOMContentLoaded", start, false );

</script>
 </body>
</html>
